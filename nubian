#!/bin/sh

SERVER=https://www.nuget.org/api/v2/package

if [ -z "$1" ]; then
  echo "Usage: $0 <nuget id> <version>" >&2
  echo "  e.g. $0 NEventStore 5.2.0"
  exit 1
fi
pkg="$1"
version="$2"
pkgurl="$SERVER/$pkg/$version"

echo Creating debian package of $pkg
dir=`mktemp -d`
cd $dir
echo "* Working dir: $dir"

echo "* Downloading and extracting $pkgurl ..."
wget -q -O ${pkg}.nupkg $pkgurl
if [ $? -ne 0 ]; then
  echo "\nError downloading $SERVER/$pkg" >&2
  exit 1
fi
unzip -q ${pkg}.nupkg
if [ $? -ne 0 ]; then
  echo "\nError unzipping ${pkg}.nupkg" >&2
  exit 1
fi
rm -f ${pkg}.nupkg

mkdir deb
cd deb

FOLDER="none"

if [ -d "../lib/Net461" ]; then
  FOLDER="Net461"
elif [ -d "../lib/net461" ]; then
  FOLDER="net461"
elif [ -d "../lib/Net452" ]; then
  FOLDER="Net452"
elif [ -d "../lib/net452" ]; then
  FOLDER="net452"
elif [ -d "../lib/Net451" ]; then
  FOLDER="Net451"
elif [ -d "../lib/net451" ]; then
  FOLDER="net451"
elif [ -d "../lib/Net45" ]; then
  FOLDER="Net45"
elif [ -d "../lib/net45" ]; then
  FOLDER="net45"
elif [ -d "../lib/Net40" ]; then
  FOLDER="Net40"
elif [ -d "../lib/net40" ]; then
  FOLDER="net40"
fi

if [ "$FOLDER" = "none" ]; then
  echo "Could not find usable framework folder"
  exit 1
fi

mkdir -p opt/mono/$pkg.$version

echo "Copying files in ../lib/$FOLDER"
cp ../lib/$FOLDER/*.* ./opt/mono/$pkg.$version

echo "* Creating git repo ..."
git init . >/dev/null
git add .
git commit -m "import $SERVER/$pkg" >/dev/null

echo "* Creating debian files ..."
mkdir -p debian/source
echo "3.0 (git)" > debian/source/format

echo TODO

git add debian
git commit -m "debianize" >/dev/null

echo "* Building debian package ..."
echo TODO
cd - >/dev/null
